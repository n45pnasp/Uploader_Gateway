<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UPLOAD FOTO KE SERVER</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h2>UPLOAD FOTO KE SERVER</h2>

  <!-- Gambar statis -->
  <div class="image-wrapper">
    <img src="upload.jpg" alt="Gambar Upload" class="static-image" />
  </div>

  <!-- Status upload -->
  <p id="status">Menunggu data dari Kodular...</p>

  <!-- Spinner -->
  <div id="loadingSpinner" class="spinner" style="display: none;"></div>

  <script>
    window.FOLDER_ID = window.FOLDER_ID || null;
    window.SCRIPT_URL = window.SCRIPT_URL || null;
    window.FILE_NAME = window.FILE_NAME || 'CTP.jpg';

    const statusEl = document.getElementById('status');
    const spinner = document.getElementById('loadingSpinner');
    let lastData = "";

    // Mengecek perubahan data dari Kodular setiap detik
    setInterval(() => {
      const data = window.AppInventor?.getWebViewString?.() || "";
      if (data && data !== lastData) {
        lastData = data;
        statusEl.textContent = "üì• Data diterima, sedang mengompres...";
        spinner.style.display = "block";
        compressBase64Image(data).then((compressed) => {
          uploadBase64(compressed, window.FILE_NAME);
        });
      }
    }, 1000);

    // Fungsi kompresi gambar base64 menggunakan canvas
    function compressBase64Image(base64, mimeType = "image/jpeg", quality = 0.7) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");

          const MAX_WIDTH = 600;
          const scaleSize = MAX_WIDTH / img.width;
          canvas.width = MAX_WIDTH;
          canvas.height = img.height * scaleSize;

          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

          const compressedBase64 = canvas.toDataURL(mimeType, quality).split(',')[1];
          resolve(compressedBase64);
        };
        img.src = "data:" + mimeType + ";base64," + base64;
      });
    }

    // Fungsi untuk upload base64 ke Apps Script
    async function uploadBase64(base64Data, namaFile) {
      if (!window.FOLDER_ID || !window.SCRIPT_URL) {
        statusEl.textContent = '‚ùó FOLDER_ID atau SCRIPT_URL belum diset.';
        spinner.style.display = 'none';
        return;
      }

      const formData = new FormData();
      formData.append("action", "upload");
      formData.append("FILE", base64Data);
      formData.append("MIMETYPE", "image/jpeg");
      formData.append("NAMA_FILE", namaFile);
      formData.append("FOLDER_ID", window.FOLDER_ID);

      try {
        statusEl.textContent = '‚è≥ Mengupload...';

        const res = await fetch(window.SCRIPT_URL, {
          method: 'POST',
          body: formData
        });

        const result = await res.text();
        spinner.style.display = 'none';

        if (result.length === 33 && /^[\w-]{33}$/.test(result)) {
          statusEl.innerHTML = `‚úÖ File berhasil diupload.<br><strong>File ID:</strong> <code>${result}</code>`;
          if (window.AppInventor) {
            window.AppInventor.setWebViewString("UPLOAD_SUCCESS:" + result);
          }
        } else {
          statusEl.innerHTML = `‚ùå Upload gagal: <br><code>${result}</code>`;
          if (window.AppInventor) {
            window.AppInventor.setWebViewString("UPLOAD_FAILED:" + result);
          }
        }
      } catch (error) {
        statusEl.textContent = '‚ùå UPLOAD_ERROR: ' + error.message;
        spinner.style.display = 'none';
        if (window.AppInventor) {
          window.AppInventor.setWebViewString("UPLOAD_ERROR:" + error.message);
        }
      }
    }
  </script>
</body>
</html>
